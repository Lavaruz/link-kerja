<%- include('./layouts/header'); -%>
<%- include('./layouts/navbar-all'); -%>

<main class="noise">
    <div class="min-h-screen w-full grid grid-cols-10">

        <!-- SIDEBAR -->
        <div class="col-span-2 border-r-2 h-screen pb-28 overflow-y-scroll">
            <form id="form-market-filter" class="flex flex-col items-center gap-4 divide-y divide-gray-300 py-6 px-4">
                <div class="w-full flex flex-col gap-4 w-full">
                    <div class="pb-4 flex justify-between w-full">
                        <p class="ps-4 text-sm text-black/70 font-medium">FILTER</p>
                        <button class="text-sm text-main/70 font-medium">CLEAR</button>
                    </div> 
                    <!-- <label for="" class="">SEARCH</label> -->
                    <p class="ps-4 text-sm font-medium">BY BASIC INFORMATION ---</p>
                    <input type="search" formControlName="search" id="input-search" value="" class="block w-full px-4 py-3 rounded-full font-medium text-sm text-gray-900 border border-gray-300 bg-gray-50 focus:ring-main focus:border-main" placeholder="Search candidate name, and position" required />
                    <select name="" id="" class="px-4 w-full text-sm font-medium rounded-full border-2 py-3 border-gray-300 focus:ring-main focus:border-main">
                        <option value="9" selected>Domicile</option>
                        <option value="12">12 Post per Page</option>
                        <option value="15">15 Post per Page</option>
                        <option value="999">Show All Post</option>
                    </select>
                </div>
                <div class="pt-4 flex flex-col gap-4 w-full">
                    <p class="ps-4 text-sm font-medium">BY EXPERIENCES ---</p>
                    <select name="" id="" class="px-4 w-full text-sm font-medium rounded-full border-2 py-3 border-gray-300 focus:ring-main focus:border-main">
                        <option value="9" selected>YoE</option>
                        <option value="12">12 Post per Page</option>
                        <option value="15">15 Post per Page</option>
                        <option value="999">Show All Post</option>
                    </select>
                    <select name="" id="" class="px-4 w-full text-sm font-medium rounded-full border-2 py-3 border-gray-300 focus:ring-main focus:border-main">
                        <option value="" selected>Departement</option>
                        <option value="Jobstreet">Jobstreet</option>
                        <option value="Glints">Glints</option>
                        <option value="Indeed">Indeed</option>
                        <option value="Kalibrr">Kalibrr</option>
                        <option value="Linkedin">Linkedin</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                </div>
                <div class="pt-4 flex flex-col gap-4 w-full">
                    <p class="ps-4 text-sm font-medium">BY EDUCATIONS ---</p>
                    <select name="" id="" class="px-4 w-full text-sm font-medium rounded-full border-2 py-3 border-gray-300 focus:ring-main focus:border-main">
                        <option value="" selected>University</option>
                        <option value="Jobstreet">Jobstreet</option>
                        <option value="Glints">Glints</option>
                        <option value="Indeed">Indeed</option>
                        <option value="Kalibrr">Kalibrr</option>
                        <option value="Linkedin">Linkedin</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                    <select name="" id="" class="px-4 w-full text-sm font-medium rounded-full border-2 py-3 border-gray-300 focus:ring-main focus:border-main">
                        <option value="" selected>Education Type</option>
                        <option value="Jobstreet">Jobstreet</option>
                        <option value="Glints">Glints</option>
                        <option value="Indeed">Indeed</option>
                        <option value="Kalibrr">Kalibrr</option>
                        <option value="Linkedin">Linkedin</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                </div>
            </form>
        </div>

        <!-- CARDS -->
        <div class="col-span-8 px-14">
            <div id="on-login" class="hidden">
                <div class="py-4">
                    <p class="text-2xl font-medium text-main">Your Profile</p>
                </div>
                <hr class="border-gray-300 pt-4">
                <!-- CARD -->
                <div class="grid grid-cols-2 gap-6">

                    <div id="my-profile">
                        <!-- HERE -->
                    </div>
                    
                    <div class="">
                        <p class="text-2xl text-black/70 font-medium">How to Activate your Card ?</p>
                        <div class="ms-2 mt-3 text-black/60">
                            <p>• Complete Your Basic Information</p>
                            <p>• Add Your Profile Educations</p>
                            <p>• Add Curicullum Vitae </p>
                            <p>• Activate Active Search in Profile Page</p>
                        </div>
                        <a href="/profile/me" class="block w-max mt-4 rounded-lg px-6 py-2 text-white font-medium text-sm bg-main">Activate your profile card</a>
                    </div>
                </div>
            </div>
            <div id="off-login" class="hidden my-4">
                <p class="text-black/60">show off your amazing profile, to make recruiter interest in you</p>
                <button id="button-create-card" class="text-white font-medium text-sm bg-main rounded-lg mt-4 px-6 py-2">Create your own card !</button>
            </div>

            
            <div class="flex justify-between items-center py-4">
                <p class="text-2xl font-medium text-main">Showing 40 Talent</p>
                <button class="shadow-md w-10 rounded-full h-10 bg-main text-white font-medium"><i class="uil uil-sliders-v"></i></button>
            </div>
            <hr class="border-gray-300">
            <!-- <p class="text-2xl font-medium">Showing 40 Talent</p> -->
            <div id="cards" class="grid grid-cols-2 gap-4 mt-8">
                <!-- CARD -->
            </div>
        </div>
    </div>
</main>

<!-- POPUP USER -->
<div id="popup" class="hidden fixed top-0 bottom-0 right-0 left-0 bg-black/60 z-30 flex items-center justify-center">
    <div id="popup-user" class="hidden w-1/3 bg-background noise rounded-2xl relative overflow-hidden">
        <div class="h-[90vh] overflow-y-scroll w-full px-12 py-8">
            <div class="text-center flex flex-col items-center justify-center">
                <div class="w-[90px] h-[90px] min-w-[90px] min-h-[90px] rounded-full overflow-hidden mx-auto lg:mx-0">
                    <img id="popup-profile-pic" src="/img/no-profile.jpg" alt="profile-picture" class="w-full h-full object-cover">
                </div>
                <p id="popup-username" class="text-2xl font-bold text-main">Assami Muzaki</p>
                <p class="font-medium text-black/60 text-sm">Founder of Internshits</p>
            </div>
    
            <hr class="my-4">
    
            <div id="popup-socials" class="flex items-center gap-6 text-thrid/80 text-xl justify-center">
                <a id="link-twitter" href="" target="_blank" class="hidden link-social"><i class="uil uil-twitter"></i></a>
                <a id="link-instagram" href="" target="_blank" class="hidden link-social"><i class="uil uil-instagram-alt"></i></a>
                <a id="link-linkedin" href="" target="_blank" class="hidden link-social"><i class="uil uil-linkedin"></i></a>
                <a id="link-behance" href="" target="_blank" class="hidden link-social"><i class="uil uil-behance"></i></a>
                <a id="link-github" href="" target="_blank" class="hidden link-social"><i class="uil uil-github"></i></a>
                <a id="link-youtube" href="" target="_blank" class="hidden link-social"><i class="uil uil-youtube"></i></a>
            </div>
    
            <hr class="my-4">
            
            <p class="text-black/80 text-center">Lorem ipsum dolor sit, amet consectetur adipisicing elit. Maxime repudiandae inventore dolores dolorum earum aliquid tempora sequi esse, omnis rem nam delectus reprehenderit itaque distinctio architecto deserunt harum illo ullam.</p>
            
            <hr class="my-4">

            <div class="py-6 flex flex-col gap-4">
                <div class="grid grid-cols-2 text-center">
                    <div class="">
                        <p class="text-xs text-black/60 font-medium">LOCATION</p>
                        <p id="popup-domicile" class="font-bold text-sm mt-2 text-black/70">Jakarta Utara</p>
                    </div>
                    <div class="">
                        <p class="text-xs text-black/60 font-medium">PHONE NUMBER</p>
                        <p id="popup-mobile" class="font-bold text-sm mt-2 text-black/70">-</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 mt-4 text-center">
                    <div class="">
                        <p class="text-xs text-black/60 font-medium">SALARY RANGE</p>
                        <p class="font-bold text-sm mt-2 text-black/70">7.5mio - 10mio</p>
                    </div>
                    <div class="">
                        <p class="text-xs text-black/60 font-medium">YOE (month)</p>
                        <p class="font-bold text-sm mt-2 text-black/70">2.5 month</p>
                    </div>
                </div>
            </div>
    
            <hr class="my-4">
    
            <div class="flex flex-col gap-2">
                <a id="popup-view" class="text-sm text-white font-medium bg-main mx-auto w-full py-2.5 rounded-lg flex justify-center">View More Detail</a>
                <button class="close-x text-sm text-main font-medium mx-auto w-full py-2 rounded-lg">Close</button>
            </div>
        </div>
    </div>
</div>


<%- include('./layouts/footer'); -%>

<script>

$.ajax({
        url: "/api/v1/users/verify-token",
        type: "GET",
        headers: {
            "Authorization": window.USER_TOKEN,
        },
        success: (isVerified) => {
            if(isVerified){
                $("#on-login").removeClass("hidden")
                $("#off-login").addClass("hidden")
            }else{
                $("#on-login").addClass("hidden")
                $("#off-login").removeClass("hidden")
            }

            $.ajax({
                url: '/api/v1/users/info',
                type: 'get',
                dataType: 'json',
                headers: {
                    "Authorization": window.USER_TOKEN,
                },
                success: async function (userData) {
                    userData = decrypt(userData.r)
                    let SKILLS = userData.skills.map(function(skill){
                        return `<button class="text-xs bg-main text-white px-2 py-1 rounded-lg">${skill.skill}</button>`
                    })
                    let ACTIVE_SKILL = SKILLS.slice(0,3)
                    let REMAIN = SKILLS.slice(ACTIVE_SKILL.length)

                    $("#my-profile").append(`
                        <div class="card-user flex self-start gap-5 rounded-2xl border border-main p-5 bg-white shadow-md hover:scale-[1.005] duration-100 cursor-pointer">
                            <div class="w-[70px] h-[70px] min-w-[70px] min-h-[70px] rounded-full overflow-hidden mx-auto lg:mx-0">
                                <img id="basic-profile-pic" src="${userData.profile_picture}" onerror="src='/img/no-profile.jpg'" alt="profile-picture" class="w-full h-full object-cover">
                            </div>
                            <div class="w-full">
                                <div class="mb-2 text-center lg:text-left">
                                    <p class="id" style="display:none">${userData.id}</p>
                                    <p id="basic-fullname" class="font-bold text-xl text-main">${userData.firstname} ${userData.lastname} ${userData.sex == 'Male' ? `<i class="uil uil-mars text-blue-500"></i>` : `<i class="uil uil-venus text-pink-500"></i>`}</p>
                                    <p id="basic-current-position" class="text-sm text-thrid/60 font-medium">Founder of Internshits</p>
                                </div>
                                <hr>
                                <div class="pt-2">
                                    <p class="text-sm flex items-center text-black/80"><i class="uil uil-award-alt"></i><span class="font-medium ms-2 me-1">${userData.YoE}</span>Month of Experience</p>
                                    <p class="text-sm flex items-center text-black/80"><i class="uil uil-bag me-2"></i>${userData.experiences.length > 0 ? userData.experiences[0].exp_position + " at " + userData.experiences[0].exp_orgname : "no experiences"}</p>
                                    <p class="text-sm flex items-center"><i class="uil uil-building"></i><span class="ms-2">${userData.educations.length > 0 ? userData.educations[0].edu_type + " - " + userData.educations[0].edu_program : "No Education Added"}</span></p>
                                    <div class="flex gap-2 mt-3 flex-wrap">
                                        ${ACTIVE_SKILL.join("")}
                                        ${REMAIN.length != 0 ? `<button class="text-xs bg-main text-white px-2 py-1 rounded-lg">+${REMAIN.length}</button>` : ""}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `)
                
                    $.get("/api/v1/users/active", function(usersData){
                        usersData = decrypt(usersData.r)
                        // usersData = filterDataById(userData, userData.id)
                        const filteredUsersData = filterDataById(usersData, userData.id)
                        filteredUsersData.forEach(user => {
                            let SKILLS = user.skills.map(function(skill){
                                return `<button class="text-xs bg-main text-white px-2 py-1 rounded-lg">${skill.skill}</button>`
                            })
                            let ACTIVE_SKILL = SKILLS.slice(0,3)
                            let REMAIN = SKILLS.slice(ACTIVE_SKILL.length)
                            $("#cards").append(`
                                <div class="card-user flex self-start gap-5 rounded-2xl border border-main p-5 bg-white shadow-md hover:scale-[1.005] duration-100 cursor-pointer">
                                    <div class="w-[70px] h-[70px] min-w-[70px] min-h-[70px] rounded-full overflow-hidden mx-auto lg:mx-0">
                                        <img id="basic-profile-pic" src="${user.profile_picture}" onerror="src='/img/no-profile.jpg'" alt="profile-picture" class="w-full h-full object-cover">
                                    </div>
                                    <div class="w-full">
                                        <div class="mb-2 text-center lg:text-left">
                                            <p class="id" style="display:none">${user.id}</p>
                                            <p id="basic-fullname" class="font-bold text-xl text-main">${user.firstname} ${user.lastname} ${user.sex == 'Male' ? `<i class="uil uil-mars text-blue-500"></i>` : `<i class="uil uil-venus text-pink-500"></i>`}</p>
                                            <p id="basic-current-position" class="text-sm text-thrid/60 font-medium">Founder of Internshits</p>
                                        </div>
                                        <hr>
                                        <div class="pt-2">
                                            <p class="text-sm flex items-center text-black/80"><i class="uil uil-award-alt"></i><span class="font-medium ms-2 me-1">${user.YoE}</span>Month of Experience</p>
                                            <p class="text-sm flex items-center text-black/80"><i class="uil uil-bag me-2"></i>${user.experiences.length > 0 ? user.experiences[0].exp_position + " at " + user.experiences[0].exp_orgname : "no experiences"}</p>
                                            <p class="text-sm flex items-center"><i class="uil uil-building"></i><span class="ms-2">${user.educations.length > 0 ? user.educations[0].edu_type + " - " + user.educations[0].edu_program : "No Education Added"}</span></p>
                                            <div class="flex gap-2 mt-3 flex-wrap">
                                                ${ACTIVE_SKILL.join("")}
                                                ${REMAIN.length != 0 ? `<button class="text-xs bg-main text-white px-2 py-1 rounded-lg">+${REMAIN.length}</button>` : ""}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `)
                        });
                    })

                },
                error: function(xhr){
                    window.location.href = "/"
                }
            });

        },
        error: function (request, status, error) {
            $("#nav-profile").addClass("hidden")
            $("#button-login").removeClass("hidden")
            return request
        },
    })

    $("#button-create-card").click(function(){
        $("#popup-layer-navbar").fadeIn(function(){
            $("#popup-login").slideToggle()
            $("body").css("overflow", "hidden")
        }).css("display", "flex")
    })

    $("#cards").on("click", ".card-user", function(){
        $("#popup").fadeIn(function(){
            $("body").addClass('no-scroll');
            $("#popup-user").slideToggle()
        }).css("display", "flex")

        const ID = $(this).find(".id").text()
        $.get(`/api/v1/users/${ID}`, function(userData){
            userData = decrypt(userData.r)
            $("#popup-username").text(`${userData.firstname} ${userData.lastname}`)
            $("#popup-domicile").text(userData.domicile ? userData.domicile : "-")
            $("#popup-mobile").text(userData.mobile ? userData.mobile : "-")
            $("#popup-view").prop("href", `/profile/${userData.id}`)
            $("#popup-profile-pic").prop("src", userData.profile_picture)

            if(userData.socials){
                if(userData.socials.twitter){
                    $("#link-twitter").removeClass("hidden").prop("href",userData.socials.twitter)
                }
                if(userData.socials.instagram){
                    $("#link-instagram").removeClass("hidden").prop("href",userData.socials.instagram)
                }
                if(userData.socials.linkedin){
                    $("#link-linkedin").removeClass("hidden").prop("href",userData.socials.linkedin)
                }
                if(userData.socials.behance){
                    $("#link-behance").removeClass("hidden").prop("href",userData.socials.behance)
                }
                if(userData.socials.github){
                    $("#link-github").removeClass("hidden").prop("href",userData.socials.github)
                }
                if(userData.socials.youtube){
                    $("#link-youtube").removeClass("hidden").prop("href",userData.socials.youtube)
                }
            }else{
                $("#popup-socials").html("-")
            }
        })
    })

    $(".close-x").click(function(){
        $("#popup-user").slideToggle(function(){
            $("body").removeClass('no-scroll');
            $("#popup").fadeOut()
        })
    })

    
    const decrypt = (data, keys='<%= process.env.AES_KEYS %>') => {
        let bytes = CryptoJS.AES.decrypt(data, keys)
        return JSON.parse(bytes.toString(CryptoJS.enc.Utf8))
    }

    function filterDataById(dataArray, excludeId) {
        console.log(dataArray);
        return dataArray.filter(item => item.id !== excludeId);
    }
</script>